name: Setup Firefox

on:
  workflow_call:
    # This is a reusable workflow that can be called by other workflows

# Concurrency group ensures only one Firefox setup runs at a time across all workflows
# This prevents race conditions when multiple workflows try to cache Firefox simultaneously
concurrency:
  group: setup-firefox-${{ github.repository }}
  cancel-in-progress: false

jobs:
  setup-firefox:
    name: Setup Firefox Cache
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Get current year-week for Firefox cache key (updates weekly)
      - name: Get current week
        id: week
        run: echo "week=$(date +%Y-W%V)" >> $GITHUB_OUTPUT

      # Cache Firefox binary to speed up installation
      # Cache key includes year-week to refresh weekly and get Firefox updates
      - name: Cache Firefox binary
        id: firefox-cache
        uses: actions/cache@v4
        with:
          path: /opt/hostedtoolcache/firefox
          key: ${{ runner.os }}-firefox-latest-v6-${{ steps.week.outputs.week }}

      # Download & install latest Firefox only if cache miss
      - name: Download & install latest Firefox
        if: steps.firefox-cache.outputs.cache-hit != 'true'
        id: setup-firefox
        uses: browser-actions/setup-firefox@latest

      # Rename cache directory and .complete marker from "latest" to actual version for tc.find() compatibility
      - name: Fix Firefox cache for tool-cache API
        if: steps.firefox-cache.outputs.cache-hit != 'true'
        run: |
          VERSION="${{ steps.setup-firefox.outputs.firefox-version }}"
          if [ -d "/opt/hostedtoolcache/firefox/latest" ]; then
            echo "Renaming /opt/hostedtoolcache/firefox/latest to /opt/hostedtoolcache/firefox/$VERSION"
            mv /opt/hostedtoolcache/firefox/latest "/opt/hostedtoolcache/firefox/$VERSION"
            # Move the .complete marker file if it exists in the version directory
            if [ -f "/opt/hostedtoolcache/firefox/$VERSION/x64.complete" ]; then
              echo "Moving .complete marker from $VERSION/x64.complete to $VERSION.complete for tc.find() compatibility"
              mv "/opt/hostedtoolcache/firefox/$VERSION/x64.complete" "/opt/hostedtoolcache/firefox/$VERSION.complete"
            fi
            echo "Firefox $VERSION cached for tool-cache API compatibility"
          fi
