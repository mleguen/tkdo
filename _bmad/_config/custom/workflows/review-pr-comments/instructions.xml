<workflow>
  <critical>The workflow execution engine is governed by: {project-root}/_bmad/core/tasks/workflow.xml</critical>
  <critical>You MUST have already loaded and processed: {installed_path}/workflow.yaml</critical>
  <critical>Communicate all responses in {communication_language} and language MUST be tailored to {user_skill_level}</critical>
  <critical>Generate all documents in {document_output_language}</critical>

  <objective>
    This workflow runs AFTER adversarial code-review completed with option 2 (Create action items).
    It merges GitHub PR comments into the existing review action items and responds to all unresolved PR comments.
  </objective>

  <critical_principle name="Reviewer Responsibility: No Premature Judgments">
    A reviewer's credibility depends on thorough investigation BEFORE classification.

    **Anti-patterns to avoid:**
    - ‚ùå "This looks like X, so INVALID"
    - ‚ùå "I don't immediately see the problem, so INVALID"
    - ‚ùå "This is [category], typically out of scope"
    - ‚ùå Quick dismissals without code reading
    - ‚ùå Assumptions based on first impression

    **Required approach:**
    1. ‚úÖ Read the questioned code thoroughly
    2. ‚úÖ Understand its context and intent (why it exists)
    3. ‚úÖ Check related code, tests, documentation
    4. ‚úÖ Form hypothesis about validity
    5. ‚úÖ Gather evidence to confirm/refute hypothesis
    6. ‚úÖ Make classification with documented reasoning showing evidence

    **Before classifying ANY comment as VALID or INVALID, ask yourself:**
    - "Have I read all the relevant code files?"
    - "Do I understand WHY it was implemented this way?"
    - "What concrete evidence am I basing this decision on?"
    - "Can I explain both what the code does AND why the author might have chosen this approach?"

    **Remember**: Saying "I need to investigate this further before deciding" is better than
    making an uninformed classification. The user expects rigor and evidence, not speed.
  </critical_principle>

  <step n="1" goal="Load story and existing review findings">
    <action>Use provided {{story_path}} or ask user which story file to review</action>
    <action>Read COMPLETE story file</action>
    <action>Set {{story_key}} = extracted key from filename (e.g., "1-2-user-authentication.md" ‚Üí "1-2-user-authentication")</action>

    <action>Locate "Review Follow-ups (AI)" subsection under Tasks/Subtasks</action>

    <check if="Review Follow-ups section exists">
      <action>Parse all existing action items in format: `- [ ] [AI-Review][Severity] Description [file:line]`</action>
      <action>Store as {{existing_findings}} list with:
        - Checkbox status
        - Severity level
        - Description
        - File/line references
      </action>
      <output>**üìã Loaded {{finding_count}} existing review findings from story**</output>
    </check>

    <check if="Review Follow-ups section does NOT exist">
      <output>‚ö†Ô∏è No "Review Follow-ups (AI)" section found in story.</output>
      <ask>Did the adversarial code-review complete with option 2 (Create action items)?

Options:
- [c] Continue anyway (I'll create the section)
- [x] Exit (run code-review first)
      </ask>

      <check if="response == x">
        <output>Please run the adversarial code-review workflow first and choose option 2 (Create action items).</output>
        <action>Exit workflow</action>
      </check>

      <check if="response == c">
        <action>Set {{existing_findings}} = empty list</action>
        <output>Continuing with empty findings list. Will create Review Follow-ups section.</output>
      </check>
    </check>
  </step>

  <step n="2" goal="Detect and retrieve GitHub PR comments">
    <action>Check if current directory is a Git repository with GitHub remote</action>

    <check if="not a git repository OR no GitHub remote">
      <output>‚ùå Not a GitHub repository. This workflow requires:
- Git repository
- GitHub remote configured
- GitHub CLI (gh) installed and authenticated
- Open PR for current branch

Exiting.</output>
      <action>Exit workflow</action>
    </check>

    <action>Check for open Pull Request using: `gh pr list --head $(git branch --show-current) --json number,url,title`</action>

    <check if="no open PR">
      <output>‚ùå No open GitHub PR found for current branch.

This workflow is designed to integrate PR review comments.
If you don't have a PR yet, the adversarial review findings in the story are already complete.

Exiting.</output>
      <action>Exit workflow</action>
    </check>

    <action>Set {{pr_number}} from detected PR</action>
    <action>Set {{pr_url}} from detected PR</action>

    <output>**‚úÖ Found open PR #{{pr_number}}**

Title: {{pr_title}}
URL: {{pr_url}}

Retrieving unresolved review comments...</output>

    <action>Retrieve all review comments using: `gh api repos/OWNER/REPO/pulls/{{pr_number}}/comments --jq '.[] | {id: .id, path: .path, line: .line, body: .body, user: .user.login, html_url: .html_url, in_reply_to_id: .in_reply_to_id}'`</action>

    <action>Filter to only root-level comments (where in_reply_to_id is null) - these are the original review comments, not replies</action>

    <action>For each root-level comment, check if it already has resolution replies:
      1. Fetch all comments for this PR again
      2. For each root comment, find any replies (where in_reply_to_id == root comment id)
      3. Check if ANY reply contains resolution markers:
         - "‚úì Classification: RESOLVED"
         - "‚úÖ **VALID**" or "‚ö™ **OUT OF SCOPE**" or "‚ö™ **INVALID**"
         - Pattern indicating prior review workflow response
      4. Mark comment as already_resolved=true if resolution reply found
      5. Filter out all comments where already_resolved=true
    </action>

    <output>**üìä Comment Status:**
- {{total_root_comments}} total root-level review comments
- {{already_resolved_count}} already resolved (have review responses)
- {{unresolved_count}} unresolved (need processing)

Proceeding with {{unresolved_count}} unresolved comments...</output>

    <check if="no unresolved comments">
      <output>‚ÑπÔ∏è No unresolved PR review comments found.

All comments have been addressed. Your review findings in the story are complete.

Exiting.</output>
      <action>Exit workflow</action>
    </check>

    <output>**üìã Found {{comment_count}} unresolved PR review comments**

From reviewers: {{reviewer_list}}

Processing each comment...</output>
  </step>

  <step n="3" goal="Investigate and validate PR comments with evidence">
    <critical>INVESTIGATION BEFORE CLASSIFICATION - No premature judgments allowed</critical>

    <action>For EACH unresolved PR comment, follow this investigation-first process:

      **Phase 1: Gather Context**
      1. Read comment body, file path, and line number
      2. Identify what the comment claims or questions
      3. Note the reviewer's concern or suggestion

      **Phase 2: Mandatory Investigation Checklist**
      Before making ANY classification decision, verify ALL of the following:

      ‚ñ° Read all relevant code files mentioned or implied by the comment
      ‚ñ° Read the specific lines questioned (with surrounding context, not just the exact line)
      ‚ñ° Understand the intent/purpose of the questioned code (why it exists, what problem it solves)
      ‚ñ° Check for related tests that cover this code
      ‚ñ° Check for related documentation or code comments explaining the behavior
      ‚ñ° Identify any related files or modules that provide context
      ‚ñ° Can explain WHY the code works this way (even if it might be wrong)
      ‚ñ° Can articulate the actual impact of the concern (not just theoretical)

      **If ANY checkbox above is unchecked ‚Üí investigate more before proceeding to Phase 3**

      **Phase 3: Evidence-Based Classification**

      Only after completing Phase 2, determine validation status with documented evidence:

      Build classification record in this format:

      ```
      **Comment {{comment_id}}**: {{file_path}}:{{line}}

      **What the comment claims:**
      {{concise_summary_of_reviewer_concern}}

      **Investigation Evidence:**
      - Read: {{list_all_files_read}} (specific lines: {{line_ranges}})
      - Code purpose: {{why_this_code_exists_and_what_it_does}}
      - Related context: {{tests_docs_related_code_found}}
      - Current behavior: {{what_actually_happens_now}}
      - Expected behavior (per comment): {{what_reviewer_expects}}

      **Impact Analysis:**
      - Actual risk: {{concrete_impact_if_comment_is_correct}}
      - Theoretical vs real: {{is_this_a_real_problem_or_edge_case}}
      - Scope: {{what_would_break_or_be_affected}}

      **Classification Decision:** [VALID/INVALID/DUPLICATE/CONSOLIDATED]

      **Reasoning:**
      {{clear_explanation_of_why_you_chose_this_classification_based_on_evidence_above}}

      {{if_VALID_or_CONSOLIDATED}}**Severity:** [CRITICAL/HIGH/MEDIUM/LOW]
      **Severity Justification:** {{why_this_severity_level}}{{endif}}

      {{if_DUPLICATE}}**Covered by existing finding:** [AI-Review][{{severity}}] {{existing_finding_description}}{{endif}}

      {{if_CONSOLIDATED}}**Root cause shared with comments:** {{list_other_comment_ids_in_group}}{{endif}}
      ```

      **Classification Types:**
      - **VALID**: Real issue that should be addressed (backed by evidence from investigation)
      - **INVALID**: False positive, out of scope, or already addressed (backed by evidence showing why not applicable)
      - **DUPLICATE**: Already covered by existing finding from adversarial review (match existing action item)
      - **CONSOLIDATED**: Valid issue that shares root cause with another VALID PR comment (will be merged into single action item)

      **Phase 4: Store Classification**
      Store validation result with:
      - comment_id
      - validation_status (VALID/INVALID/DUPLICATE/CONSOLIDATED)
      - severity (if VALID or CONSOLIDATED)
      - finding_description
      - file_reference (file:line)
      - investigation_evidence (all files read, evidence gathered)
      - decision_reasoning (why this classification)
      - linked_finding_index (if DUPLICATE)
      - consolidated_group_id (if CONSOLIDATED)
      - comment_thread_url (html_url from PR comment)
    </action>

    <check critical="true" title="Self-Review: Did I investigate thoroughly?">
      <action>Before presenting results, verify for EACH comment:
        - ‚úì I read the actual code, not just the comment
        - ‚úì I understand why the code exists this way
        - ‚úì My classification is based on evidence, not assumptions
        - ‚úì I can defend my reasoning with specific file:line references
        - ‚úì If I classified as INVALID, I have concrete evidence it's not an issue
      </action>

      <check if="any verification fails">
        <output>‚ö†Ô∏è Investigation incomplete for some comments. Continuing investigation...</output>
        <action>Return to Phase 2 for incomplete comments</action>
      </check>
    </check>

    <output>**‚úÖ PR Comment Validation Complete (Evidence-Based)**

Results:
- {{valid_count}} VALID comments (will add as standalone action items)
- {{consolidated_count}} CONSOLIDATED comments (will merge into {{consolidated_groups}} action items)
- {{duplicate_count}} DUPLICATE comments (already covered by existing findings)
- {{invalid_count}} INVALID/OUT-OF-SCOPE comments

Breakdown by severity:
- CRITICAL: {{critical_count}}
- HIGH: {{high_count}}
- MEDIUM: {{medium_count}}
- LOW: {{low_count}}

**Investigation Stats:**
- Total files read: {{files_read_count}}
- Average investigation depth: {{avg_context_lines_read}} lines per comment

**PR URLs to track:** {{valid_count + consolidated_count + duplicate_count}} (all must appear in action items)
    </output>
  </step>

  <step n="4" goal="Merge PR comments into story action items">
    <critical>Update the story file's Review Follow-ups section with merged findings</critical>

    <action>Build updated action items list:
      1. Keep all existing findings from {{existing_findings}}
      2. For DUPLICATE PR comments: Append PR comment thread link to existing finding
      3. For standalone VALID PR comments: Add as new action items with single PR link
      4. For CONSOLIDATED PR comments: Create one action item per group with ALL PR links from that group
    </action>

    <action>Format action items:
      - Existing (no PR link): `- [ ] [AI-Review][Severity] Description [file:line]`
      - With single PR link: `- [ ] [AI-Review][Severity] Description [file:line] [PR#{{pr_number}} comment]({{url}})`
      - With multiple PR links (consolidated): `- [ ] [AI-Review][Severity] Description [file:line] [PR#{{pr_number}} comments: [Label1]({{url1}}), [Label2]({{url2}}), ...]`

      <critical>When consolidating multiple PR comments into one action item, ALL comment URLs MUST be included.
      Each URL represents a thread that needs a response when the fix is implemented.
      Use short labels (e.g., file:line or issue type) to identify each link.</critical>
    </action>

    <action>Sort by severity: CRITICAL ‚Üí HIGH ‚Üí MEDIUM ‚Üí LOW</action>

    <action>Update story file:
      1. Locate "### Review Follow-ups (AI)" subsection
      2. If doesn't exist: Create it under "## Tasks / Subtasks"
      3. Replace entire subsection content with merged action items
      4. Preserve all other sections and content
    </action>

    <check critical="true" title="Verify all PR comments are linked">
      <action>Count total PR comment URLs appearing in updated action items</action>
      <action>Compare against: VALID + DUPLICATE + CONSOLIDATED comment count from Step 3</action>
      <check if="counts do not match">
        <output>‚ö†Ô∏è **MISMATCH**: {{linked_urls}} PR URLs in action items vs {{processed_comments}} comments processed.
Missing URLs mean some PR threads won't be resolved when fixes are implemented.</output>
        <action>Review action items and add missing PR comment links before proceeding</action>
      </check>
    </check>

    <output>**‚úÖ Story Updated**

Updated "Review Follow-ups (AI)" section with:
- {{total_findings}} total action items
- {{new_from_pr}} new findings from PR comments
- {{linked_count}} existing findings linked to PR comments
- {{pr_urls_linked}} PR comment URLs linked (should equal processed comments)

File: {{story_file}}</output>
  </step>

  <step n="5" goal="Respond to all unresolved GitHub PR comments">
    <critical>Follow .claude/README.md guidelines for PR comment responses</critical>

    <action>Read {claude_readme} Pull Request Review Responses section</action>

    <output>**üìù Responding to {{comment_count}} GitHub PR Comments**

Following .claude/README.md guidelines:
- Using /comments/COMMENT_ID/replies endpoint for threaded responses
- NOT using markdown "#X" shorthand (GitHub interprets as PR references)
- Providing full context about action items

Posting individual responses...</output>

    <action>For EACH unresolved PR comment:
      1. Build response based on validation status, INCLUDING INVESTIGATION EVIDENCE:

      **If VALID (standalone - new finding added):**
      ```
      ‚úÖ **VALID** - Confirmed this is {{issue_summary}}.

      **Investigation:**
      {{brief_summary_of_evidence_gathered}}
      - Verified: {{what_was_checked}}
      - Impact: {{actual_impact_found}}

      **Added to story action items:**
      - Action Item: [AI-Review][{{severity}}] {{finding_description}} [{{file_reference}}]
      - Story file: {{story_file}}
      - Tasks/Subtasks ‚Üí Review Follow-ups (AI) section

      This will be addressed in a follow-up.
      ```

      **If CONSOLIDATED (first comment in group - full response):**
      ```
      ‚úÖ **VALID** - Confirmed this is {{issue_summary}}.

      **Investigation:**
      {{brief_summary_of_evidence_gathered}}
      - Verified: {{what_was_checked}}
      - Impact: {{actual_impact_found}}

      **Added to story action items:**
      - Action Item: [AI-Review][{{severity}}] {{finding_description}} [{{file_reference}}]
      - Story file: {{story_file}}
      - Tasks/Subtasks ‚Üí Review Follow-ups (AI) section

      This comment and {{other_count}} related comments will be addressed together in a follow-up.
      ```

      **If CONSOLIDATED (subsequent comments in group - short reference):**
      ```
      ‚úÖ **VALID** - Related issue, tracked together with [this comment]({{first_comment_reply_url}}).
      ```

      **If DUPLICATE (already covered):**
      ```
      ‚úÖ **VALID** - Confirmed {{issue_summary}}.

      **Investigation:**
      {{brief_summary_showing_this_matches_existing_finding}}

      **Already covered in existing action item:**
      - Action Item: [AI-Review][{{severity}}] {{existing_finding_description}} [{{file_reference}}]
      - Story file: {{story_file}}
      - Tasks/Subtasks ‚Üí Review Follow-ups (AI) section

      Linked this PR comment to the existing finding.
      ```

      **If INVALID/OUT-OF-SCOPE:**
      ```
      ‚ö™ **OUT OF SCOPE** - {{concise_reason}}

      **Investigation:**
      {{show_what_was_checked_to_reach_this_conclusion}}
      - Verified: {{files_read_and_checked}}
      - Current behavior: {{what_code_actually_does}}
      - Reasoning: {{why_this_is_not_an_issue_or_out_of_scope}}
      ```

      2. CRITICAL: Never use "#X" - write "Action Item: [AI-Review][SEVERITY]" instead
      3. CRITICAL: Give full context - readers don't know the action item numbering
      4. CRITICAL: Show investigation evidence - demonstrates thorough review, not quick dismissal
      5. CRITICAL: For CONSOLIDATED groups, post to FIRST comment first, capture reply URL, then use it for subsequent comments
      6. Post using: `gh api -X POST repos/OWNER/REPO/pulls/{{pr_number}}/comments/{{comment_id}}/replies -f body="{{response}}"`
      7. Verify successful posting and capture {{reply_url}} from response html_url field
    </action>

    <output>**‚úÖ All PR Comments Responded**

Posted {{response_count}} threaded replies in PR #{{pr_number}}.

All responses are visible in the Files Changed review tab under their respective code lines.</output>
  </step>

  <step n="6" goal="Update story status and summary">
    <action>Add completion note to story's Dev Agent Record ‚Üí Completion Notes List:

**{{date}} - PR Comments Reviewed (Evidence-Based Investigation):**
- Reviewed {{comment_count}} unresolved GitHub PR comments ({{already_resolved_count}} already resolved, filtered out)
- Investigation: Read {{files_read_count}} files with {{avg_context_lines_read}} avg lines per comment
- Validated: {{valid_count}} valid, {{duplicate_count}} duplicate, {{invalid_count}} invalid
- Updated Review Follow-ups section with {{total_findings}} action items
- Responded to all comments in PR #{{pr_number}} with investigation evidence
    </action>

    <action>Ensure story Status remains "in-progress" (since action items exist)</action>
    <action>Save story file</action>

    <output>**‚úÖ Workflow Complete!**

**Summary:**
- Story: {{story_file}}
- PR: #{{pr_number}} ({{pr_url}})
- Comments Reviewed: {{comment_count}}
- Action Items: {{total_findings}} total ({{new_from_pr}} new from PR)
- All PR comments responded in threaded conversations

**Next Steps:**
1. Review the "Review Follow-ups (AI)" section in {{story_file}}
2. Address the action items (fix code, add tests, update docs)
3. Run code-review again to verify fixes
4. Mark action items as [x] when complete

The story status is "in-progress" until all action items are resolved.</output>
  </step>

</workflow>
