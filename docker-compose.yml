services:
  angular:
    build: ./front/docker/angular
    volumes:
      - ./front/dist:/mnt/dist

  front:
    build: ./docker/front
    depends_on:
      - angular
      - slim-web
    ports:
      - ${FRONT_DEV_PORT:-8080}:80

  front-https:
    build: ./docker/front-https
    depends_on:
      - angular
      - slim-web
    ports:
      - ${FRONT_HTTPS_DEV_PORT:-8443}:443
    volumes:
      - ./docker/certs:/usr/local/apache2/conf/certs:ro
    profiles:
      - https

  maildev:
    image: maildev/maildev
    ports:
      - ${MAILDEV_DEV_PORT:-1080}:1080

  mysql:
    image: mysql:5.6
    environment:
      MYSQL_DATABASE: tkdo
      MYSQL_USER: tkdo
      MYSQL_PASSWORD: mdptkdo
      MYSQL_ROOT_PASSWORD: mdproot
    healthcheck:
      test: >
        out=$$(mysqladmin ping -h localhost -P 3306 -u $$MYSQL_USER --password=$$MYSQL_PASSWORD 2>&1);
        echo $$out | grep 'mysqld is alive' || { echo $$out; exit 1; }
      interval: 5s
      retries: 10
      start_interval: 1s
      start_period: 30s

  npm:
    build:
      context: ./front/docker/npm
      args:
        DEV_GID: ${DEV_GID:-1000}
        DEV_UID: ${DEV_UID:-1000}
    cap_add:
      # Mandatory to be able to run chrome without --no-sandbox option
      - SYS_ADMIN
    environment:
      - CYPRESS_CACHE_FOLDER=/mnt/tkdo/.cache/Cypress
      - CYPRESS_HTTPS=${CYPRESS_HTTPS:-false}
      - FRONT_HTTPS_DEV_PORT=${FRONT_HTTPS_DEV_PORT:-8443}
      - NG_CLI_ANALYTICS=false
      - NPM_CONFIG_CACHE=/mnt/tkdo/.cache/npm
    volumes:
      - ./:/mnt/tkdo


  k6:
    image: grafana/k6
    profiles:
      - tools
    user: ${DEV_UID:-1000}:${DEV_GID:-1000}
    volumes:
      - .:/opt/tkdo
    working_dir: /opt/tkdo

  php-cli:
    build: docker/php-cli
    environment:
      HOME: /opt/tkdo
      XDG_CACHE_HOME: /opt/tkdo/.cache
      TKDO_DEV_MODE: "1"
      docker: "true"
      MAILDEV_BASE_URI: http://maildev:1080/
      MYSQL_DATABASE: tkdo
      MYSQL_HOST: mysql
      MYSQL_PASSWORD: mdptkdo
      MYSQL_PORT: 3306
      MYSQL_USER: tkdo
      OAUTH2_ISSUER_BASE_URI: http://slim-web
      TKDO_API_BASE_URI: http://slim-web
      TKDO_BASE_URI: http://front
      TKDO_MAILER_FROM: noreply@slim
    profiles:
      - tools
    user: ${UID:-1000}:${GID:-1000}
    volumes:
      - .:/opt/tkdo
    working_dir: /opt/tkdo/api

  slim-fpm:
    build: ./docker/slim-fpm
    depends_on:
      mysql:
        condition: service_healthy
      maildev:
        condition: service_started
    environment:
      docker: "true"
      MYSQL_DATABASE: tkdo
      MYSQL_HOST: mysql
      MYSQL_PASSWORD: mdptkdo
      MYSQL_PORT: 3306
      MYSQL_USER: tkdo
      OAUTH2_ISSUER_BASE_URI: http://slim-web
      TKDO_BASE_URI: http://front
      TKDO_DEV_MODE: "1"
      TKDO_MAILER_FROM: noreply@slim
      WWW_GID: ${GID:-1000}
      WWW_UID: ${UID:-1000}
    volumes:
      - ./api:/var/www/html
      - ./docker/slim-fpm/docker-php-entrypoint:/usr/local/bin/docker-php-entrypoint

  slim-web:
    depends_on:
      - slim-fpm
    image: nginx:1.27
    ports:
      - ${API_DEV_PORT:-8081}:80
    volumes:
      - ./api:/var/www/html
      - ./docker/slim-web/default.conf:/etc/nginx/conf.d/default.conf

